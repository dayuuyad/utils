pipeline {
    agent any

    stages {


        stage('SonarQube Analysis') {
            steps {
                timeout(time: 30, unit: 'MINUTES') {

                    script {
                        // 1. 先检查 SonarScanner 是否存在
                        def scannerHome = tool 'sonarqubeScanner'

                        // 2. 检查 SonarQube 环境变量是否注入
                        withSonarQubeEnv('sonarqube') {
                            // 先打印环境变量
                            bat """
                                echo "scannerHome: ${scannerHome}"
                                echo "SONAR_HOST_URL: ${SONAR_HOST_URL}"
                                echo "当前工作目录: ${cd}"
                                echo "测试网络连通性..."
                                ping -n 3 ${SONAR_HOST_URL}
                            """

                            // 3. 先执行一个简单的命令测试
                            bat "\"${scannerHome}\\bin\\sonar-scanner\" -v"

                            // 4. 简化扫描命令
                            bat """
                                "${scannerHome}\\bin\\sonar-scanner" ^
                                -Dsonar.projectKey=test-project ^
                                -Dsonar.sources=src ^
                                -Dsonar.projectBaseDir=. ^
                                -X  # 启用调试模式
                            """
                        }
                    }
                }
            }
        }



    }




}
